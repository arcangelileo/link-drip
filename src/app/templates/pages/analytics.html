{% extends "layouts/dashboard.html" %}

{% block title %}Analytics: {{ link.title or link.slug }} — LinkDrip{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Breadcrumb & Header -->
<div class="mb-8">
    <nav class="flex items-center text-sm text-gray-500 mb-4">
        <a href="/dashboard" class="hover:text-gray-700 transition-colors">Links</a>
        <svg class="w-4 h-4 mx-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
        <span class="text-gray-900 font-medium">Analytics</span>
    </nav>
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">{{ link.title or link.slug }}</h1>
            <div class="mt-1.5 flex flex-wrap items-center gap-3 text-sm">
                <a href="{{ short_url }}" target="_blank" class="text-brand-600 hover:text-brand-700 font-medium transition-colors">{{ short_url }}</a>
                <span class="text-gray-300">|</span>
                <span class="text-gray-500 truncate max-w-xs">{{ link.target_url }}</span>
            </div>
            {% if link.tags %}
            <div class="mt-2 flex flex-wrap gap-1">
                {% for tag in link.tags.split(',') %}
                <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium bg-gray-100 text-gray-600 rounded-full">{{ tag.strip() }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="flex items-center gap-3">
            <a href="/dashboard/links/{{ link.id }}/export" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export CSV
            </a>
            <a href="/dashboard/links/{{ link.id }}/qr" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z" />
                </svg>
                QR Code
            </a>
        </div>
    </div>
</div>

<!-- Stats Overview Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <p class="text-sm font-medium text-gray-500">Total Clicks</p>
        <p class="mt-1 text-3xl font-bold text-gray-900">{{ stats.total_clicks }}</p>
    </div>
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <p class="text-sm font-medium text-gray-500">Top Country</p>
        <p class="mt-1 text-3xl font-bold text-gray-900">
            {% if stats.top_countries %}{{ stats.top_countries[0].name }}{% else %}—{% endif %}
        </p>
    </div>
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <p class="text-sm font-medium text-gray-500">Top Browser</p>
        <p class="mt-1 text-3xl font-bold text-gray-900 truncate">
            {% if stats.top_browsers %}{{ stats.top_browsers[0].name }}{% else %}—{% endif %}
        </p>
    </div>
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <p class="text-sm font-medium text-gray-500">Top Device</p>
        <p class="mt-1 text-3xl font-bold text-gray-900">
            {% if stats.devices %}{{ stats.devices[0].name }}{% else %}—{% endif %}
        </p>
    </div>
</div>

{% if stats.total_clicks == 0 %}
<!-- Empty State -->
<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-12 text-center">
    <div class="w-16 h-16 bg-brand-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
        <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-1">No clicks yet</h3>
    <p class="text-sm text-gray-500 mb-4">Share your link to start collecting analytics data.</p>
    <div class="inline-flex items-center bg-gray-50 rounded-xl px-4 py-2.5 text-sm">
        <span class="text-brand-600 font-medium mr-2">{{ short_url }}</span>
        <button onclick="navigator.clipboard.writeText('{{ short_url }}')" class="p-1 text-gray-400 hover:text-gray-600 rounded transition-colors" title="Copy">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
        </button>
    </div>
</div>
{% else %}

<!-- Clicks Over Time Chart -->
<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Clicks Over Time</h2>
    <div class="h-64">
        <canvas id="clicksChart"></canvas>
    </div>
</div>

<!-- Analytics Grid -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
    <!-- Top Countries -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Countries</h2>
        {% if stats.top_countries %}
        <div class="space-y-3">
            {% for item in stats.top_countries %}
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-700">{{ item.name }}</span>
                <div class="flex items-center gap-3">
                    <div class="w-24 bg-gray-100 rounded-full h-2">
                        <div class="bg-brand-500 h-2 rounded-full" style="width: {{ (item.count / stats.total_clicks * 100)|round(1) }}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900 w-12 text-right">{{ item.count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No country data available.</p>
        {% endif %}
    </div>

    <!-- Top Referrers -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Top Referrers</h2>
        {% if stats.top_referrers %}
        <div class="space-y-3">
            {% for item in stats.top_referrers %}
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-700 truncate max-w-[200px]" title="{{ item.name }}">{{ item.name }}</span>
                <div class="flex items-center gap-3">
                    <div class="w-24 bg-gray-100 rounded-full h-2">
                        <div class="bg-green-500 h-2 rounded-full" style="width: {{ (item.count / stats.total_clicks * 100)|round(1) }}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900 w-12 text-right">{{ item.count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No referrer data available. Clicks came via direct traffic.</p>
        {% endif %}
    </div>

    <!-- Browsers -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Browsers</h2>
        {% if stats.top_browsers %}
        <div class="space-y-3">
            {% for item in stats.top_browsers %}
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-700 truncate max-w-[200px]">{{ item.name }}</span>
                <div class="flex items-center gap-3">
                    <div class="w-24 bg-gray-100 rounded-full h-2">
                        <div class="bg-purple-500 h-2 rounded-full" style="width: {{ (item.count / stats.total_clicks * 100)|round(1) }}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900 w-12 text-right">{{ item.count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No browser data available.</p>
        {% endif %}
    </div>

    <!-- Operating Systems -->
    <div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Operating Systems</h2>
        {% if stats.top_os %}
        <div class="space-y-3">
            {% for item in stats.top_os %}
            <div class="flex items-center justify-between">
                <span class="text-sm text-gray-700 truncate max-w-[200px]">{{ item.name }}</span>
                <div class="flex items-center gap-3">
                    <div class="w-24 bg-gray-100 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: {{ (item.count / stats.total_clicks * 100)|round(1) }}%"></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900 w-12 text-right">{{ item.count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-sm text-gray-500">No OS data available.</p>
        {% endif %}
    </div>
</div>

<!-- Device Breakdown -->
{% if stats.devices %}
<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6 mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4">Device Breakdown</h2>
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        {% for item in stats.devices %}
        <div class="text-center p-4 bg-gray-50 rounded-xl">
            <div class="w-10 h-10 mx-auto mb-2 rounded-lg flex items-center justify-center
                {% if item.name == 'Desktop' %}bg-blue-100 text-blue-600
                {% elif item.name == 'Mobile' %}bg-green-100 text-green-600
                {% elif item.name == 'Tablet' %}bg-purple-100 text-purple-600
                {% elif item.name == 'Bot' %}bg-gray-200 text-gray-600
                {% else %}bg-gray-100 text-gray-600{% endif %}
            ">
                {% if item.name == 'Desktop' %}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                {% elif item.name == 'Mobile' %}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                {% elif item.name == 'Tablet' %}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                {% else %}
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                {% endif %}
            </div>
            <p class="text-2xl font-bold text-gray-900">{{ item.count }}</p>
            <p class="text-xs text-gray-500 mt-0.5">{{ item.name }}</p>
            <p class="text-xs text-gray-400">{{ (item.count / stats.total_clicks * 100)|round(1) }}%</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recent Clicks Table -->
<div class="bg-white rounded-2xl border border-gray-200 shadow-sm p-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Recent Clicks</h2>
        <span class="text-sm text-gray-500">Last 20 clicks</span>
    </div>
    {% if stats.recent_clicks %}
    <div class="overflow-x-auto -mx-6">
        <table class="w-full text-sm">
            <thead>
                <tr class="border-b border-gray-100">
                    <th class="text-left font-medium text-gray-500 px-6 py-3">Time</th>
                    <th class="text-left font-medium text-gray-500 px-6 py-3">Country</th>
                    <th class="text-left font-medium text-gray-500 px-6 py-3">Browser</th>
                    <th class="text-left font-medium text-gray-500 px-6 py-3">OS</th>
                    <th class="text-left font-medium text-gray-500 px-6 py-3">Device</th>
                    <th class="text-left font-medium text-gray-500 px-6 py-3">Referrer</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
                {% for click in stats.recent_clicks %}
                <tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-6 py-3 text-gray-700 whitespace-nowrap">
                        {{ click.clicked_at.strftime('%b %d, %H:%M') if click.clicked_at else '—' }}
                    </td>
                    <td class="px-6 py-3 text-gray-700">{{ click.country or '—' }}</td>
                    <td class="px-6 py-3 text-gray-700 truncate max-w-[150px]">{{ click.browser or '—' }}</td>
                    <td class="px-6 py-3 text-gray-700 truncate max-w-[150px]">{{ click.os or '—' }}</td>
                    <td class="px-6 py-3">
                        {% if click.device %}
                        <span class="inline-flex items-center px-2 py-0.5 text-xs font-medium rounded-full
                            {% if click.device == 'Desktop' %}bg-blue-50 text-blue-700
                            {% elif click.device == 'Mobile' %}bg-green-50 text-green-700
                            {% elif click.device == 'Tablet' %}bg-purple-50 text-purple-700
                            {% elif click.device == 'Bot' %}bg-gray-100 text-gray-700
                            {% else %}bg-gray-50 text-gray-700{% endif %}
                        ">{{ click.device }}</span>
                        {% else %}—{% endif %}
                    </td>
                    <td class="px-6 py-3 text-gray-500 truncate max-w-[200px]" title="{{ click.referrer or '' }}">{{ click.referrer or 'Direct' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p class="text-sm text-gray-500">No click data yet.</p>
    {% endif %}
</div>

{% endif %}
{% endblock %}

{% block scripts %}
{% if stats.total_clicks > 0 and stats.daily_clicks %}
<script>
const dailyData = {{ stats.daily_clicks|tojson }};
const ctx = document.getElementById('clicksChart').getContext('2d');
new Chart(ctx, {
    type: 'line',
    data: {
        labels: dailyData.map(d => {
            const date = new Date(d.date);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }),
        datasets: [{
            label: 'Clicks',
            data: dailyData.map(d => d.count),
            borderColor: '#2563eb',
            backgroundColor: 'rgba(37, 99, 235, 0.08)',
            borderWidth: 2,
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#2563eb',
            pointBorderColor: '#fff',
            pointBorderWidth: 2,
            pointHoverRadius: 6,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false },
            tooltip: {
                backgroundColor: '#1e293b',
                titleColor: '#f8fafc',
                bodyColor: '#f8fafc',
                padding: 12,
                cornerRadius: 8,
                displayColors: false,
            },
        },
        scales: {
            x: {
                grid: { display: false },
                ticks: { color: '#9ca3af', font: { size: 12 } },
            },
            y: {
                beginAtZero: true,
                grid: { color: '#f3f4f6' },
                ticks: {
                    color: '#9ca3af',
                    font: { size: 12 },
                    precision: 0,
                },
            },
        },
    },
});
</script>
{% endif %}
{% endblock %}
